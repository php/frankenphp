# Развертывание в production

В этом руководстве мы рассмотрим, как развернуть PHP-приложение на одном сервере с использованием Docker Compose.

Если вы используете Symfony, рекомендуется прочитать раздел "[Deploy in production](https://github.com/dunglas/symfony-docker/blob/main/docs/production.md)" документации проекта Symfony Docker (в котором используется FrankenPHP).

Если вы используете API Platform (который также использует FrankenPHP), ознакомьтесь с [документацией по развертыванию этого фреймворка](https://api-platform.com/docs/deployment/).

## Подготовка приложения

Сначала создайте файл `Dockerfile` в корневой директории вашего PHP-проекта:

```dockerfile
FROM dunglas/frankenphp

# Обязательно замените "your-domain-name.example.com" на ваше доменное имя
ENV SERVER_NAME=your-domain-name.example.com
# Если вы хотите отключить HTTPS, используйте вместо этого:
#ENV SERVER_NAME=:80

# Если ваш проект не использует директорию "public" в качестве корневой веб-директории, вы можете указать её здесь:
# ENV SERVER_ROOT=web/

# Включите настройки PHP для production
RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"

# Скопируйте файлы PHP вашего проекта в публичную директорию
COPY . /app/public
# Если вы используете Symfony или Laravel, вам нужно скопировать весь проект вместо этого:
#COPY . /app
```

Ознакомьтесь с разделом "[Создание кастомных Docker-образов](docker.md)" для получения дополнительных подробностей и опций, а также чтобы узнать, как настроить конфигурацию, установить PHP-расширения и модули Caddy.

Если ваш проект использует Composer, убедитесь, что он включён в Docker-образ, и установите свои зависимости.

Затем добавьте файл `compose.yaml`:

```yaml
services:
  php:
    image: dunglas/frankenphp
    restart: always
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "443:443/udp" # HTTP/3
    volumes:
      - caddy_data:/data
      - caddy_config:/config

# Тома, необходимые для сертификатов и конфигурации Caddy
volumes:
  caddy_data:
  caddy_config:
```

> [!NOTE]
>
> Примеры выше предназначены для использования в production.
> В процессе разработки вы можете захотеть использовать том, другую конфигурацию PHP и другое значение для переменной окружения `SERVER_NAME`.
>
> Ознакомьтесь с проектом [Symfony Docker](https://github.com/dunglas/symfony-docker) (который использует FrankenPHP) для более сложного примера с использованием многостадийных образов, Composer, дополнительных PHP-расширений и т.д.

Наконец, если вы используете Git, зафиксируйте эти файлы и отправьте их.

## Подготовка сервера

Для развертывания вашего приложения в production вам потребуется сервер. В этом руководстве мы будем использовать виртуальную машину, предоставляемую DigitalOcean, но подойдёт любой Linux-сервер.
Если у вас уже есть Linux-сервер с установленным Docker, вы можете сразу перейти к [следующему разделу](#настройка-доменного-имени).

В противном случае, используйте [эту партнерскую ссылку](https://m.do.co/c/5d8aabe3ab80), чтобы получить $200 бесплатного кредита, создайте аккаунт, затем нажмите "Create a Droplet".
Затем перейдите во вкладку "Marketplace" в разделе "Choose an image" и найдите приложение "Docker". Это создаст сервер на Ubuntu с уже установленными последними версиями Docker и Docker Compose!

Для целей тестирования будет достаточно самых дешевых планов.
Для реального использования в production вы, вероятно, захотите выбрать план из раздела "general purpose" в соответствии с вашими потребностями.

![Развертывание FrankenPHP на DigitalOcean с Docker](digitalocean-droplet.png)

Вы можете оставить настройки по умолчанию для других параметров или изменить их в соответствии с вашими потребностями.
Не забудьте добавить свой SSH-ключ или создать пароль, затем нажмите кнопку "Finalize and create".

Затем подождите несколько секунд, пока ваш Droplet будет подготавливаться.
Когда ваш Droplet будет готов, подключитесь через SSH:

```console
ssh root@<droplet-ip>
```

## Настройка доменного имени

В большинстве случаев вам потребуется связать доменное имя с вашим сайтом.
Если у вас еще нет доменного имени, вам придется приобрести его через регистратора.

Затем создайте DNS-запись типа `A` для вашего доменного имени, указывающую на IP-адрес вашего сервера:

```dns
your-domain-name.example.com.  IN  A     207.154.233.113
```

Пример с использованием сервиса DigitalOcean Domains ("Networking" > "Domains"):

![Настройка DNS в DigitalOcean](digitalocean-dns.png)

> [!NOTE]
>
> Let's Encrypt, сервис, используемый FrankenPHP по умолчанию для автоматической генерации TLS-сертификата, не поддерживает использование чистых IP-адресов. Для использования Let's Encrypt обязательно наличие доменного имени.

## Развертывание

Скопируйте ваш проект на сервер с помощью `git clone`, `scp` или любого другого инструмента, который может подойти для ваших нужд.
Если вы используете GitHub, вы можете захотеть использовать [ключ развёртывания](https://docs.github.com/en/free-pro-team@latest/developers/overview/managing-deploy-keys#deploy-keys).
Ключи развёртывания также [поддерживаются GitLab](https://docs.gitlab.com/ee/user/project/deploy_keys/).

Пример с использованием Git:

```console
git clone git@github.com:<username>/<project-name>.git
```

Перейдите в директорию, содержащую ваш проект (`<project-name>`), и запустите приложение в режиме production:

```console
docker compose up --wait
```

Ваш сервер запущен и работает, и HTTPS-сертификат был автоматически сгенерирован для вас.
Перейдите на `https://your-domain-name.example.com` и наслаждайтесь!

> [!CAUTION]
>
> Docker может иметь слой кэша, убедитесь, что у вас правильная сборка для каждого развертывания, или пересоберите ваш проект с опцией `--no-cache` во избежание проблем с кэшем.

## Развертывание на несколько узлов

Если вы хотите развернуть ваше приложение на кластере машин, вы можете использовать [Docker Swarm](https://docs.docker.com/engine/swarm/stack-deploy/), который совместим с предоставленными файлами Compose.
Для развертывания на Kubernetes ознакомьтесь с [Helm-чартом, предоставляемым API Platform](https://api-platform.com/docs/deployment/kubernetes/), который использует FrankenPHP.
